# Platform Detection
is-macos() { [[ "$OSTYPE" =~ ^darwin ]] || return 1; }
is-linux() { [[ "$OSTYPE" =~ ^linux ]] || return 1; }
is-ubuntu() { is-linux && [[ -f /etc/lsb-release ]] && grep -q "Ubuntu" /etc/lsb-release 2>/dev/null; }
is-apt-available() { command -v apt-get >/dev/null 2>&1; }
is-snap-available() { command -v snap >/dev/null 2>&1; }

# Dynamic Homebrew prefix (supports Intel + Apple Silicon)
get-brew-prefix() {
  if is-macos; then
    if [[ "$(uname -m)" == "arm64" ]]; then
      echo "/opt/homebrew"
    else
      echo "/usr/local"
    fi
  fi
}

# Feature detection
is-executable() {
  type "$1" >/dev/null 2>&1 || return 1
}

# Check if a GUI app exists (cross-platform)
# Usage: app-exists "Firefox" or app-exists "Firefox.app"
app-exists() {
  local app_name="${1%.app}"  # strip .app if present

  if is-macos; then
    # Check common macOS app locations
    [[ -d "/Applications/${app_name}.app" ]] && return 0
    [[ -d "$HOME/Applications/${app_name}.app" ]] && return 0
    # mdfind is faster than find for macOS
    mdfind "kMDItemKind == 'Application' && kMDItemDisplayName == '${app_name}'" 2>/dev/null | grep -q . && return 0
  elif is-linux; then
    # Check for .desktop file (standard Linux app registration)
    local desktop_name="${app_name,,}"  # lowercase
    desktop_name="${desktop_name// /-}" # spaces to dashes
    [[ -f "/usr/share/applications/${desktop_name}.desktop" ]] && return 0
    [[ -f "$HOME/.local/share/applications/${desktop_name}.desktop" ]] && return 0
    # Check common Linux app paths
    [[ -d "/opt/${desktop_name}" ]] && return 0
    [[ -f "/usr/local/bin/${desktop_name}" ]] && return 0
  fi
  return 1
}

# Check if a command or app exists (tries CLI first, then GUI)
# Usage: cmd-or-app-exists "firefox" "Firefox"
#        cmd-or-app-exists "code"  # CLI only
cmd-or-app-exists() {
  local cmd_name="$1"
  local app_name="${2:-}"

  # Check CLI command first
  command -v "$cmd_name" >/dev/null 2>&1 && return 0

  # Check GUI app if name provided
  [[ -n "$app_name" ]] && app-exists "$app_name" && return 0

  return 1
}

is-supported() {
  if [ $# -eq 1 ]; then
    if eval "$1" >/dev/null 2>&1; then true; else false; fi
  else
    if eval "$1" >/dev/null 2>&1; then
      echo -n "$2"
    else
      echo -n "$3"
    fi
  fi
}

# Add to path
prepend-path() {
  [ -d $1 ] && PATH="$1:$PATH"
}

# Update config file
set-config() {
  local KEY="$1"
  local VALUE="$2"
  local FILE="$3"
  touch "$FILE"
  if grep -q "$1=" "$FILE"; then
    if is-macos; then
      sed -i '' "s@$KEY=.*@$KEY=\"$VALUE\"@" "$FILE"
    else
      sed -i "s@$KEY=.*@$KEY=\"$VALUE\"@" "$FILE"
    fi
  else
    echo "export $KEY=\"$VALUE\"" >>"$FILE"
  fi
}

pyclean() {
  find . -type f -name '*.py[co]' -delete -o -type d -name __pycache__ -delete
}

# time how fast the shell loads
timezsh() {
  shell=${1-$SHELL}
  for i in $(seq 1 10); do /usr/bin/time $shell -i -c exit; done
}

# clear the biber cache
clean_biber_cache() {
  rm -rf $(biber --cache)
}
